name: "Install EKS-A in Ubuntu"
description: "Component to install eks-anywhere in an ubuntu AMI"
schemaVersion: 1.0
parameters:
  - ManifestsPath:
      type: string
      default: '/usr/lib/eks-a/manifests'
      description: The full path where eks-a manifests will be downloaded
  - ArtifactsTarPath:
      type: string
      default: '/usr/lib/eks-a/artifacts/artifacts.tar'
      description: The path where the tar containing all eks-a container artifacts will be stored
phases:
  - name: build
    steps:
      - name: DownloadManifests
        action: ExecuteBash
        inputs:
          commands:
            - MANIFESTS_PATH='{{ ManifestsPath }}'
            - sudo mkdir -p $MANIFESTS_PATH
            - sudo eksctl anywhere download artifacts --retain-dir --download-dir $MANIFESTS_PATH -v4
            - sudo chmod -R a+r $MANIFESTS_PATH
      - name: DownloadImages
        action: ExecuteBash
        inputs:
          commands:
            - ARTIFACTS_PATH='{{ ArtifactsTarPath }}'
            - ARTIFACTS_NAME_DIR=$(dirname $ARTIFACTS_PATH)
            - sudo mkdir -p $ARTIFACTS_NAME_DIR
            - sudo eksctl anywhere download images -o $ARTIFACTS_PATH -v4
            - sudo chmod -R a+r $ARTIFACTS_NAME_DIR
  - name: validate
    steps:
      - name: VerifyManifests
        action: ExecuteBash
        inputs:
          commands:
            - MANIFESTS_PATH='{{ ManifestsPath }}'
            - |
              if test -d $MANIFESTS_PATH; then
                  echo "manifests dir exists."
                  exit 0
              else
                  echo "manifests dir does not exist. Failing."
                  exit 1
              fi
      - name: VerifyImagesTar
        action: ExecuteBash
        inputs:
          commands:
            - ARTIFACTS_PATH='{{ ArtifactsTarPath }}'
            - |
              if test -f $ARTIFACTS_PATH; then
                  echo "Artifacts tarball exists."
                  exit 0
              else
                  echo "Artifacts tarball does not exist. Failing."
                  exit 1
              fi
